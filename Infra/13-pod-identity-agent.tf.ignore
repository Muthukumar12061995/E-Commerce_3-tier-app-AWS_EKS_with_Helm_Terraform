resource "aws_eks_addon" "eks_pod_identity_agent" {
  cluster_name = aws_eks_cluster.eks.name
  addon_name = "eks-pod-identity-agent"
  addon_version = "v1.3.2-eksbuild.2"
}

# Using terraform template file to render json dynamic

data "template_file" "pod_role_json" {
  template = file("${path.module}/json_template/trust_policy.json")

  vars = {
    principal_type ="Service"
    principal = "pod.eks.amazonaws.com"
    action = "sts:AssumeRole"
  }
}

resource "aws_iam_role" "pod_identity_agent_role" {
  name = "pod_identity_agent_role"
  assume_role_policy = data.template_file.pod_role_json.rendered
}

resource "aws_iam_role_policy_attachment" "pod_identity_agent_role_access_policy" {
  role = aws_iam_role.pod_identity_agent_role.name
  policy_arn = "arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess"
}